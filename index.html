<!DOCTYPE html>
<html>
<head>
  <title>QC Review Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f0f0f0; }
    input[type="text"], select { width: 100%; padding: 4px; }
    label { margin-right: 15px; }
    button { padding: 6px 12px; background: #007bff; color: #fff; border: none; border-radius: 4px; }
    button:disabled { background: #ccc; }
  </style>
</head>
<body>

  <h2>QC Review Dashboard</h2>
  <label>Start Date: <input type="date" id="startDate"></label>
  <label>End Date: <input type="date" id="endDate"></label>
  <label>User:
    <select id="qcFilter"><option value="">All</option></select>
  </label>
  <label>Enterprise:
    <select id="enterpriseFilter"><option value="">All</option></select>
  </label>
  <button onclick="applyFilters()">Filter</button>

  <div id="table-container">Loading...</div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data';
    const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeQH6R9-rYr1Kh2rwUBKu7uGvJAkRrvx8fnxF6jfkac7sNL2A/formResponse';

    let globalData = [];

    function loadAndFilterCSV() {
      fetch(CSV_URL)
        .then(res => res.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              globalData = results.data;
              populateDropdowns();
              applyFilters();
            }
          });
        });
    }

    function populateDropdowns() {
      const qcSet = new Set(), entSet = new Set();
      globalData.forEach(row => {
        if (row['QC']) qcSet.add(row['QC']);
        if (row['Enterprise']) entSet.add(row['Enterprise']);
      });
      const qcFilter = document.getElementById('qcFilter');
      const entFilter = document.getElementById('enterpriseFilter');
      qcFilter.innerHTML = '<option value="">All</option>' + [...qcSet].map(v => `<option>${v}</option>`).join('');
      entFilter.innerHTML = '<option value="">All</option>' + [...entSet].map(v => `<option>${v}</option>`).join('');
    }

    function applyFilters() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const user = document.getElementById('qcFilter').value;
      const ent = document.getElementById('enterpriseFilter').value;

      const filtered = globalData.filter(row => {
        const date = row['Date']?.split('T')[0];
        return row['QC'] &&
          (!start || date >= start) &&
          (!end || date <= end) &&
          (!user || row['QC'] === user) &&
          (!ent || row['Enterprise'] === ent);
      });

      renderTable(filtered);
    }

    function renderTable(data) {
      if (!data.length) {
        document.getElementById('table-container').innerHTML = 'No matching data.';
        return;
      }

      let html = `<table><tr>
        <th>Spin ID</th><th>SKU ID</th><th>Issue</th><th>Enterprise</th><th>QC</th>
        <th>Comment</th><th>Submit</th></tr>`;

      data.forEach((row, i) => {
        html += `<tr>
          <td>${row['Spin ID']}</td>
          <td>${row['Sku ID']}</td>
          <td>${row['Issue']}</td>
          <td>${row['Enterprise']}</td>
          <td>${row['QC']}</td>
          <td><input type="text" id="comment_${i}"></td>
          <td><button onclick="submitFormRow(${i})" id="btn_${i}">Submit</button></td>
        </tr>`;
      });

      html += '</table>';
      document.getElementById('table-container').innerHTML = html;
    }

    function submitFormRow(i) {
      const row = document.querySelectorAll("#qc-table tr")[i+1].children;
      const spinId = row[0].innerText;
      const skuId = row[1].innerText;
      const issue = row[2].innerText;
      const enterprise = row[3].innerText;
      const qc = row[4].innerText;
      const comment = document.getElementById(`comment_${i}`).value;

      const form = document.createElement("form");
      form.action = FORM_URL;
      form.method = "POST";
      form.target = "hidden_iframe";

      form.innerHTML = `
        <input name="entry.1125049159" value="${spinId}">
        <input name="entry.703277665" value="${skuId}">
        <input name="entry.1815472287" value="${enterprise}">
        <input name="entry.582537694" value="${qc}">
        <input name="entry.575622617" value="${issue}">
      `;

      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      const btn = document.getElementById(`btn_${i}`);
      btn.disabled = true;
      btn.innerText = "Submitted";
    }

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      const lastWeek = new Date(); lastWeek.setDate(lastWeek.getDate() - 7);
      document.getElementById('endDate').value = today;
      document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
      loadAndFilterCSV();
    };
  </script>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
</body>
</html>
