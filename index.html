<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f9f9f9;
    }
    h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .filters label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }
    .filters input, .filters select {
      padding: 6px;
      font-size: 14px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f0f0f0;
    }
    button {
      padding: 6px 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <h2>360 QC Review Dashboard</h2>

  <div class="filters">
    <label>Start Date: <input type="date" id="startDate" /></label>
    <label>End Date: <input type="date" id="endDate" /></label>
    <label>User:
      <select id="userFilter"><option value="">All</option></select>
    </label>
    <label>Enterprise:
      <select id="enterpriseFilter"><option value="">All</option></select>
    </label>
    <button onclick="applyFilters()">Filter</button>
  </div>

  <div id="table-container">Loading...</div>
<script>
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data';
  const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeQH6R9-rYr1Kh2rwUBKu7uGvJAkRrvx8fnxF6jfkac7sNL2A/formResponse';

  let globalData = [];
  let filteredData = [];

  // Escape HTML for safe rendering
  function escapeHtml(text) {
    if (!text) return '';
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Load CSV and initialize dropdowns & table
  function loadAndFilterCSV() {
    fetch(CSV_URL)
      .then(res => res.text())
      .then(csv => {
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          transformHeader: header => header.trim(),
          complete: function(results) {
            globalData = results.data;
            populateDropdowns();
            applyFilters();
          },
          error: function(err) {
            document.getElementById('table-container').innerText = 'Error loading data.';
            console.error('CSV load error:', err);
          }
        });
      }).catch(err => {
        document.getElementById('table-container').innerText = 'Error fetching CSV.';
        console.error('Fetch error:', err);
      });
  }

  // Populate User and Enterprise dropdown filters dynamically
  function populateDropdowns() {
    const userSet = new Set(), entSet = new Set();
    globalData.forEach(row => {
      if (row['User']) userSet.add(row['User']);
      if (row['Enterprise']) entSet.add(row['Enterprise']);
    });
    document.getElementById('userFilter').innerHTML =
      '<option value="">All</option>' + 
      [...userSet].map(v => `<option value="${v.trim()}">${escapeHtml(v)}</option>`).join('');
    document.getElementById('enterpriseFilter').innerHTML =
      '<option value="">All</option>' + 
      [...entSet].map(v => `<option value="${v.trim()}">${escapeHtml(v)}</option>`).join('');
  }

  // Filter data based on selected filters and date range
  function applyFilters() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const user = document.getElementById('userFilter').value;
    const ent = document.getElementById('enterpriseFilter').value;

    filteredData = globalData.filter(row => {
      if (!row['User']) return false;
      const rawDate = row['Date'] ? row['Date'].split('T')[0].trim() : '';
      if (!rawDate) return false;
      if (start && rawDate < start) return false;
      if (end && rawDate > end) return false;
      if (user && (!row['User'] || row['User'].trim().toLowerCase() !== user.trim().toLowerCase())) return false;
      if (ent && (!row['Enterprise'] || row['Enterprise'].trim().toLowerCase() !== ent.trim().toLowerCase())) return false;
      return true;
    });

    renderTable(filteredData);
  }

  // Render the filtered data table with escaped content and line breaks in Issues
  function renderTable(data) {
    if (!data.length) {
      document.getElementById('table-container').innerHTML = 'No matching data.';
      return;
    }

    let html = `<table id="qc-table"><tr>
      <th>Spin_ID</th><th>SKU_ID</th><th>Issues</th><th>Enterprise</th><th>User</th><th>Spin URL</th>
      <th>Comment</th><th>Submit</th></tr>`;

    data.forEach((row, i) => {
      const spinId = escapeHtml(row['Spin_ID'] || '');
      const skuId = escapeHtml(row['SKU_ID'] || '');
      const enterprise = escapeHtml(row['Enterprise'] || '');
      const user = escapeHtml(row['User'] || '');
      const spinURL = row['spin_url'] || '';
      const issuesHtml = escapeHtml(row['Issues'] || '').replace(/\n/g, '<br>');

      html += `<tr>
        <td>${spinId}</td>
        <td>${skuId}</td>
        <td>${issuesHtml}</td>
        <td>${enterprise}</td>
        <td>${user}</td>
        <td><a href="${spinURL}" target="_blank" rel="noopener noreferrer">Link</a></td>
        <td><input type="text" id="comment_${i}" /></td>
        <td><button onclick="submitFormRow(${i})" id="btn_${i}">Submit</button></td>
      </tr>`;
    });

    html += '</table>';
    document.getElementById('table-container').innerHTML = html;
  }
  // Escape for form input values (attribute context)
  function escapeHtmlAttr(text) {
    if (!text) return '';
    return text.replace(/&/g, "&amp;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#39;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;");
  }

  // Submit single row form data to Google Form and disable button
  function submitFormRow(i) {
    const row = filteredData[i];
    const spinId = escapeHtmlAttr(row['Spin_ID'] || '');
    const skuId = escapeHtmlAttr(row['SKU_ID'] || '');
    const enterprise = escapeHtmlAttr(row['Enterprise'] || '');
    const user = escapeHtmlAttr(row['User'] || '');
    const issue = escapeHtmlAttr(row['Issues'] || '');
    const comment = escapeHtmlAttr(document.getElementById(`comment_${i}`).value);

    const form = document.createElement("form");
    form.action = FORM_URL;
    form.method = "POST";
    form.target = "hidden_iframe";
    form.style.display = "none";

    form.innerHTML = `
      <input name="entry.1125049159" value="${spinId}">
      <input name="entry.703277665" value="${skuId}">
      <input name="entry.1815472287" value="${enterprise}">
      <input name="entry.582537694" value="${user}">
      <input name="entry.575622617" value="${issue}">
      <input name="entry.1234567890" value="${comment}">
    `;

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    const btn = document.getElementById(`btn_${i}`);
    btn.disabled = true;
    btn.innerText = "Submitted";
  }

  window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    const lastWeek = new Date();
    lastWeek.setDate(lastWeek.getDate() - 7);
    document.getElementById('endDate').value = today;
    document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
    loadAndFilterCSV();
  };
</script>

<iframe name="hidden_iframe" style="display:none;"></iframe>

</body>
</html>
