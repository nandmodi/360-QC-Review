<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
      margin: 0;
    }
    h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .filters label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      color: #333;
    }
    .filters input, .filters select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 5px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      align-self: end;
      height: 38px;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #f0f0f0;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <h2>QC Review Dashboard</h2>
  <div class="filters">
    <label>Start Date: <input type="date" id="startDate"></label>
    <label>End Date: <input type="date" id="endDate"></label>
    <label>User: <select id="qcFilter"></select></label>
    <label>Enterprise: <select id="enterpriseFilter"></select></label>
    <button onclick="applyFilters()">Filter</button>
  </div>

  <div id="table-container">Loading...</div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1JlcXL8X1VRxlRVGyTuLElsm9IgOiteT6amOEXrEx-jY/gviz/tq?tqx=out:csv&sheet=Data';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAT4uN3mUO0bTAV3j1Ikcl8zNLbMnhuEryWxMTfNAQzuJVuiz9J9CWUPxHDKqXc3QAlA/exec';

    let globalData = [];

    function loadAndInitialize() {
      fetch(CSV_URL)
        .then(response => response.text())
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              globalData = results.data;
              populateDropdowns();
              applyFilters();
            }
          });
        });
    }

    function populateDropdowns() {
      const qcSet = new Set();
      const enterpriseSet = new Set();

      globalData.forEach(row => {
        if (row['QC']) qcSet.add(row['QC']);
        if (row['Enterprise']) enterpriseSet.add(row['Enterprise']);
      });

      const qcFilter = document.getElementById('qcFilter');
      const enterpriseFilter = document.getElementById('enterpriseFilter');

      qcFilter.innerHTML = '<option value="">All</option>' + [...qcSet].sort().map(val => `<option value="${val}">${val}</option>`).join('');
      enterpriseFilter.innerHTML = '<option value="">All</option>' + [...enterpriseSet].sort().map(val => `<option value="${val}">${val}</option>`).join('');
    }

    function applyFilters() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const qcFilter = document.getElementById('qcFilter').value;
      const enterpriseFilter = document.getElementById('enterpriseFilter').value;

      const filtered = globalData.filter(row => {
        const rowDate = row['Date']?.split('T')[0];
        return (!startDate || rowDate >= startDate) &&
               (!endDate || rowDate <= endDate) &&
               (!qcFilter || row['QC'] === qcFilter) &&
               (!enterpriseFilter || row['Enterprise'] === enterpriseFilter);
      });

      renderTable(filtered);
    }

    function renderTable(data) {
      if (!data.length) {
        document.getElementById('table-container').innerHTML = '<p>No matching data found.</p>';
        return;
      }

      let html = `<table><thead><tr>
        <th>Spin ID</th><th>Sku ID</th><th>Issue</th><th>Enterprise</th><th>QC</th>
        <th>Comment</th><th>Submit</th>
      </tr></thead><tbody>`;

      data.forEach((row, i) => {
        const spinId = encodeURIComponent(row['Spin ID'] || '');
        const skuId = encodeURIComponent(row['Sku ID'] || '');
        const issue = encodeURIComponent(row['Issue'] || '');
        const enterprise = encodeURIComponent(row['Enterprise'] || '');
        const qc = encodeURIComponent(row['QC'] || '');

        html += `<tr>
          <td>${row['Spin ID'] || ''}</td>
          <td>${row['Sku ID'] || ''}</td>
          <td>${row['Issue'] || ''}</td>
          <td>${row['Enterprise'] || ''}</td>
          <td>${row['QC'] || ''}</td>
          <td><input type="text" id="comment_${i}" /></td>
          <td><button onclick="submitReview('${spinId}', '${skuId}', '${enterprise}', '${qc}', '${issue}', ${i})">Submit</button></td>
        </tr>`;
      });

      html += '</tbody></table>';
      document.getElementById('table-container').innerHTML = html;
    }

    function submitReview(spinIdEnc, skuIdEnc, enterpriseEnc, qcEnc, issueEnc, i) {
      const spinId = decodeURIComponent(spinIdEnc);
      const skuId = decodeURIComponent(skuIdEnc);
      const enterprise = decodeURIComponent(enterpriseEnc);
      const qc = decodeURIComponent(qcEnc);
      const issue = decodeURIComponent(issueEnc);
      const comment = document.getElementById(`comment_${i}`).value;

      fetch(WEB_APP_URL, {
        method: 'POST',
        body: JSON.stringify({ spinId, skuId, enterprise, qc, issue }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.text())
      .then(msg => alert("Submitted: " + msg))
      .catch(err => alert("Error submitting: " + err));
    }

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      const lastWeek = new Date();
      lastWeek.setDate(lastWeek.getDate() - 7);
      document.getElementById('endDate').value = today;
      document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
      loadAndInitialize();
    };
  </script>
</body>
</html>
